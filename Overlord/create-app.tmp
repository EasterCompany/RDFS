#! /usr/bin/python3
import sys
import shutil as sh
from os import system as s, getcwd as _cwd, remove as rm, chdir
cpv = True if sys.version_info[1] >= 8 else False
cwd=_cwd()

try:
  s("clear")

  print("\nWelcome to the Overlord Installer!\n")
  n=input("Project Name: ")
  print(f"\n> Creating Project: {n} @ {cwd}")

  print("  ⏳ Downloading Overlord     ", end="\r")

  try:
    s(f"git clone --quiet --single-branch --branch Prd --depth=1 git@github.com:EasterCompany/Overlord.git {n}")
  except Exception as download_error:
    print(f"\n\n{download_error}\n\n"), rm(__file__), exit()

  print("  ✅ Successfully Downloaded  ")

  if not cpv:print(f"""
  ************************* ATTENTION *************************
  Overlord only supports Python 3.10 or greater and
  it looks like your system default at '/usr/bin/python3'
  is running on version '{sys.version_info[0]}.{sys.version_info[1]}'

  Unfortunately until this is fixed you'll need to install your
  Overlord application manually.

  You need to run this command from within your app directory:

  >> python3.10 core.py tools install

  you can replace 'python3.10' with whatever version you wish
  to use as long as it's a greater version
  *************************************************************
  """)

  else:
    print(f"\n> Installing Project: {n} @ {cwd}")

    print(f"  ⏳ Cleaning Source Code", end="\r")
    chdir(f"{cwd}/{n}")
    sh.rmtree("./.git")
    rm("./README.md")
    rm("./SECURITY.md")
    print(f"  ✅ Successfully Cleaned Source Code")

    s(f"{sys.executable} -m pip install -r ./core/requirements.txt")
    s(f"{sys.executable} -m pip install -r ./core/requirements.dev")
    s(f"{sys.executable} core.py tools install")
    print(f"  ✅ Your Project Was Setup Successfully\n    @> {cwd}/{n}")
    print(
      f"    Enter the directory using 'cd {n}' and then\n"
      "    Use the `./o` command to open the Overlord-CLI\n"
      "    Or use `python3 core.py tools install` to reinstall manually.\n"
    )

except Exception as error:
  print("\n\nSorry, an unexpected fatal error was encountered.\nAborting Installation process...\n\n")
  print(error)
  print('\n\n')

chdir(cwd)
rm(__file__)
